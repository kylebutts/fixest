<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>Aggregates the values of DiD coefficients a la Sun and Abraham — aggregate.fixest • fixest</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Aggregates the values of DiD coefficients a la Sun and Abraham — aggregate.fixest"><meta name="description" content="Simple tool that aggregates the value of CATT coefficients in staggered
difference-in-difference setups (see details)."><meta property="og:description" content="Simple tool that aggregates the value of CATT coefficients in staggered
difference-in-difference setups (see details)."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">fixest</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.12.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/fixest_walkthrough.html">Fast Fixed-Effects Estimation: Short Introduction</a></li>
    <li><a class="dropdown-item" href="../articles/multiple_estimations.html">Multiple estimations</a></li>
    <li><a class="dropdown-item" href="../articles/standard_errors.html">On standard-errors</a></li>
    <li><a class="dropdown-item" href="../articles/collinearity.html">On collinearity</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Estimation tables</h6></li>
    <li><a class="dropdown-item" href="../articles/exporting_tables.html">Exporting estimation tables</a></li>
    <li><a class="dropdown-item" href="../articles/etable_new_features.html">`etable`: new features in `fixest` 0.10.2</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/lrberge/fixest/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Aggregates the values of DiD coefficients a la Sun and Abraham</h1>
      <small class="dont-index">Source: <a href="https://github.com/lrberge/fixest/blob/HEAD/R/did.R" class="external-link"><code>R/did.R</code></a></small>
      <div class="d-none name"><code>aggregate.fixest.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Simple tool that aggregates the value of CATT coefficients in staggered
difference-in-difference setups (see details).</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="co"># S3 method for class 'fixest'</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">agg</span>, full <span class="op">=</span> <span class="cn">FALSE</span>, use_weights <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">...</span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-x">x<a class="anchor" aria-label="anchor" href="#arg-x"></a></dt>
<dd><p>A <code>fixest</code> object.</p></dd>


<dt id="arg-agg">agg<a class="anchor" aria-label="anchor" href="#arg-agg"></a></dt>
<dd><p>A character scalar describing the variable names to be aggregated,
it is pattern-based. For <code><a href="sunab.html">sunab</a></code> estimations, the following keywords work: "att",
"period", "cohort" and <code>FALSE</code> (to have full disaggregation). All variables that
match the pattern will be aggregated. It must be of the form <code>"(root)"</code>, the parentheses
must be there and the resulting variable name will be <code>"root"</code>. You can add another
root with parentheses: <code>"(root1)regex(root2)"</code>, in which case the resulting
name is <code>"root1::root2"</code>. To name the resulting variable differently you can pass
a named vector: <code>c("name" = "pattern")</code> or <code>c("name" = "pattern(root2)")</code>. It's a
bit intricate sorry, please see the examples.</p></dd>


<dt id="arg-full">full<a class="anchor" aria-label="anchor" href="#arg-full"></a></dt>
<dd><p>Logical scalar, defaults to <code>FALSE</code>. If <code>TRUE</code>, then all coefficients
are returned, not only the aggregated coefficients.</p></dd>


<dt id="arg-use-weights">use_weights<a class="anchor" aria-label="anchor" href="#arg-use-weights"></a></dt>
<dd><p>Logical, default is <code>TRUE</code>. If the estimation was weighted,
whether the aggregation should take into account the weights. Basically if the
weights reflected frequency it should be <code>TRUE</code>.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Arguments to be passed to <code><a href="summary.fixest.html">summary.fixest</a></code>.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>It returns a matrix representing a table of coefficients.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>This is a function helping to replicate the estimator from Sun and Abraham (2021).
You first need to perform an estimation with cohort and relative periods dummies
(typically using the function <code><a href="i.html">i</a></code>), this leads to estimators of the cohort
average treatment effect on the treated (CATT). Then you can use this function to
retrieve the average treatment effect on each relative period, or for any other way
you wish to aggregate the CATT.</p>
<p>Note that contrary to the SA article, here the cohort share in the sample is
considered to be a perfect measure for the cohort share in the population.</p>
    </div>
    <div class="section level2">
    <h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a></h2>
    <p>Liyang Sun and Sarah Abraham, 2021, "Estimating Dynamic Treatment Effects in
Event Studies with Heterogeneous Treatment Effects". Journal of Econometrics.</p>
    </div>
    <div class="section level2">
    <h2 id="author">Author<a class="anchor" aria-label="anchor" href="#author"></a></h2>
    <p>Laurent Berge</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">#</span></span></span>
<span class="r-in"><span><span class="co"># DiD example</span></span></span>
<span class="r-in"><span><span class="co">#</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">base_stagg</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># 2 kind of estimations:</span></span></span>
<span class="r-in"><span><span class="co"># - regular TWFE model</span></span></span>
<span class="r-in"><span><span class="co"># - estimation with cohort x time_to_treatment interactions, later aggregated</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Note: the never treated have a time_to_treatment equal to -1000</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Now we perform the estimation</span></span></span>
<span class="r-in"><span><span class="va">res_twfe</span> <span class="op">=</span> <span class="fu"><a href="feols.html">feols</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="fu"><a href="i.html">i</a></span><span class="op">(</span><span class="va">time_to_treatment</span>, <span class="va">treated</span>,</span></span>
<span class="r-in"><span>                            ref <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">1000</span><span class="op">)</span><span class="op">)</span> <span class="op">|</span> <span class="va">id</span> <span class="op">+</span> <span class="va">year</span>, <span class="va">base_stagg</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># we use the "i." prefix to force year_treated to be considered as a factor</span></span></span>
<span class="r-in"><span><span class="va">res_cohort</span> <span class="op">=</span> <span class="fu"><a href="feols.html">feols</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x1</span> <span class="op">+</span> <span class="fu"><a href="i.html">i</a></span><span class="op">(</span><span class="va">time_to_treatment</span>, <span class="va">i.year_treated</span>,</span></span>
<span class="r-in"><span>                              ref <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="op">-</span><span class="fl">1000</span><span class="op">)</span><span class="op">)</span> <span class="op">|</span> <span class="va">id</span> <span class="op">+</span> <span class="va">year</span>, <span class="va">base_stagg</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Displaying the results</span></span></span>
<span class="r-in"><span><span class="fu"><a href="coefplot.html">iplot</a></span><span class="op">(</span><span class="va">res_twfe</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">6</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">att_true</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span><span class="va">base_stagg</span><span class="op">$</span><span class="va">treatment_effect_true</span>,</span></span>
<span class="r-in"><span>                  <span class="va">base_stagg</span><span class="op">$</span><span class="va">time_to_treatment</span>, <span class="va">mean</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="op">-</span><span class="fl">9</span><span class="op">:</span><span class="fl">8</span> <span class="op">+</span> <span class="fl">0.15</span>, <span class="va">att_true</span>, pch <span class="op">=</span> <span class="fl">15</span>, col <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># The aggregate effect for each period</span></span></span>
<span class="r-in"><span><span class="va">agg_coef</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="va">res_cohort</span>, <span class="st">"(ti.*nt)::(-?[[:digit:]]+)"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">9</span><span class="op">:</span><span class="op">-</span><span class="fl">2</span>, <span class="fl">0</span><span class="op">:</span><span class="fl">8</span><span class="op">)</span> <span class="op">+</span> <span class="fl">.35</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">agg_coef</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>, pch <span class="op">=</span> <span class="fl">17</span>, col <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">ci_low</span> <span class="op">=</span> <span class="va">agg_coef</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">agg_coef</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="va">ci_up</span> <span class="op">=</span> <span class="va">agg_coef</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span> <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span> <span class="va">agg_coef</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/segments.html" class="external-link">segments</a></span><span class="op">(</span>x0 <span class="op">=</span> <span class="va">x</span>, y0 <span class="op">=</span> <span class="va">ci_low</span>, x1 <span class="op">=</span> <span class="va">x</span>, y1 <span class="op">=</span> <span class="va">ci_up</span>, col <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/graphics/legend.html" class="external-link">legend</a></span><span class="op">(</span><span class="st">"topleft"</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">4</span><span class="op">)</span>, pch <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">20</span>, <span class="fl">15</span>, <span class="fl">17</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>       legend <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"TWFE"</span>, <span class="st">"True"</span>, <span class="st">"Sun &amp; Abraham"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-plt img"><img src="aggregate.fixest-1.png" alt="" width="700" height="433"></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># The ATT</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="va">res_cohort</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ATT"</span> <span class="op">=</span> <span class="st">"treatment::[^-]"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>      Estimate Std. Error   t value     Pr(&gt;|t|)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> ATT -1.133749  0.2050705 -5.528584 2.882038e-07</span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">base_stagg</span>, <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">treatment_effect_true</span><span class="op">[</span><span class="va">time_to_treatment</span> <span class="op">&gt;=</span> <span class="fl">0</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] -1</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># The total effect for each cohort</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/stats/aggregate.html" class="external-link">aggregate</a></span><span class="op">(</span><span class="va">res_cohort</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cohort"</span> <span class="op">=</span> <span class="st">"::[^-].*year_treated::([[:digit:]]+)"</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>              Estimate Std. Error     t value     Pr(&gt;|t|)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> cohort::2   2.4347382  0.2860464   8.5116905 2.666655e-13</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> cohort::3   1.3766102  0.6197413   2.2212658 2.873387e-02</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> cohort::4   0.7543763  0.8054956   0.9365368 3.513968e-01</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> cohort::5  -2.8079538  0.3865452  -7.2642310 1.080972e-10</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> cohort::6  -2.7225787  0.5950041  -4.5757310 1.448581e-05</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> cohort::7  -5.0751928  0.5676398  -8.9408692 3.282508e-14</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> cohort::8  -5.0928206  0.3505856 -14.5266109 9.239445e-26</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> cohort::9  -7.2367302  0.3288544 -22.0058788 7.398376e-39</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> cohort::10 -8.7115753  0.5128055 -16.9880706 2.100254e-30</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Laurent Berge.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer></div>





  </body></html>

